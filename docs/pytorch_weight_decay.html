---

title: Pytorch weight decay


keywords: fastai
sidebar: home_sidebar

summary: "Pytorch weight decay or L2 penalty"
description: "Pytorch weight decay or L2 penalty"
nb_path: "19_pytorch_weight_decay.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 19_pytorch_weight_decay.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Without-weight-decay">Without weight decay<a class="anchor-link" href="#Without-weight-decay"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="n">w_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="n">x_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x_np</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">w_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">w_np</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original weights: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>

<span class="n">lr</span>  <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">sgd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">w_tensor</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">y_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x_tensor</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">y_tensor</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">sgd</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">sgd</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="n">w_grad</span> <span class="o">=</span> <span class="n">w_tensor</span><span class="o">.</span><span class="n">grad</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Zero weight decay: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Original weights: 
 tensor([[ 0.1507,  0.1129,  0.2012, -0.5800, -0.6269],
        [-0.7232, -0.4622, -0.4373, -0.2994, -0.7394],
        [-0.4603,  0.1499, -0.1938,  0.1462, -0.6543],
        [ 0.1149,  0.4953,  0.1455, -0.2306,  0.2811]], dtype=torch.float64,
       requires_grad=True)
Zero weight decay: 
 tensor([[-0.0264, -0.0643,  0.0241, -0.7572, -0.8040],
        [-0.9386, -0.6776, -0.6527, -0.5148, -0.9548],
        [-0.6258, -0.0155, -0.3592, -0.0192, -0.8197],
        [ 0.0058,  0.3861,  0.0364, -0.3397,  0.1719]], dtype=torch.float64,
       requires_grad=True)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="With-weight-decay">With weight decay<a class="anchor-link" href="#With-weight-decay"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">w_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">w_np</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reset original weights: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>

<span class="n">sgd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([</span><span class="n">w_tensor</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">y_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x_tensor</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">y_tensor</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">sgd</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">sgd</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="n">w_grad</span> <span class="o">=</span> <span class="n">w_tensor</span><span class="o">.</span><span class="n">grad</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One weight decay: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">w_tensor</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Reset original weights: 
 tensor([[0.8594, 0.8215, 0.9099, 0.1286, 0.0818],
        [0.1384, 0.3994, 0.4243, 0.5622, 0.1222],
        [0.2014, 0.8116, 0.4680, 0.8079, 0.0074],
        [0.5516, 0.9319, 0.5822, 0.2061, 0.7178]], dtype=torch.float64,
       requires_grad=True)
One weight decay: 
 tensor([[ 0.5963,  0.5622,  0.6417, -0.0614, -0.1036],
        [-0.0908,  0.1440,  0.1665,  0.2906, -0.1054],
        [ 0.0158,  0.5650,  0.2558,  0.5617, -0.1588],
        [ 0.3873,  0.7296,  0.4148,  0.0763,  0.5368]], dtype=torch.float64,
       requires_grad=True)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

